(()=>{"use strict";window.constants={PIN_MAIN_WIDTH:62,PIN_MAIN_HEIGHT:62,PIN_MAIN_HEIGHT_ACTIVE:84},window.backend={load:(e,t,o,r,n="")=>{const s=new XMLHttpRequest;s.responseType="json",s.addEventListener("load",(()=>{switch(s.status){case 200:o(s.response);break;case 400:r("Неверный запрос");break;case 401:r("Ошибка авторизации");break;case 403:r("Доступ запрещен");break;case 404:r("Запрашиваемый ресурс не найден");break;case 500:r("Внутренняя ошибка сервера");break;default:r("Статус ответа: "+s.status+" "+s.statusText)}})),s.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за "+s.timeout+"мс")})),s.timeout=1e4,s.open(e,t),s.send(n)}},window.debounce=e=>{let t=null;return o=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(o)}),500)}},(()=>{const e=["jpg","jpeg","png","gif"],t=document.querySelector("#avatar"),o=document.querySelector("#images"),r=document.querySelector(".ad-form-header__preview"),n=document.querySelector(".ad-form__photo");t.addEventListener("change",(()=>{const o=t.files[0],n=o.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{r.querySelector("img").src=e.result})),e.readAsDataURL(o)}})),o.addEventListener("change",(()=>{const t=o.files[0],r=t.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{const t=document.createElement("img");t.src=e.result,t.width="70",t.height="70",n.appendChild(t)})),e.readAsDataURL(t)}}))})(),(()=>{const e=document.querySelector(".map__filters"),t=document.querySelector("#housing-type"),o=document.querySelector("#housing-price"),r=document.querySelector("#housing-rooms"),n=document.querySelector("#housing-guests"),s=document.querySelector("#housing-features");e.addEventListener("change",window.debounce((()=>{window.map.closeCard(),window.pin.deletePins(),window.filter.filteredOffers=window.page.offers.filter((e=>(e=>"any"===t.value||e.offer.type===t.value)(e)&&(e=>{switch(o.value){case"any":return!0;case"low":return e.offer.price<1e4;case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"high":return e.offer.price>5e4;default:return!1}})(e)&&(e=>"any"===r.value||e.offer.rooms.toString()===r.value)(e)&&(e=>"any"===n.value||e.offer.guests.toString()===n.value)(e)&&(e=>{const t=s.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))})(e))),window.pin.renderPins(window.filter.filteredOffers)}))),window.filter={filteredOffers:[]}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=e=>{const o=t.cloneNode(!0);return o.style.left=e.location.x-25+"px",o.style.top=e.location.y-70+"px",o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o};window.pin={renderPins:t=>{const r=document.createDocumentFragment();let n=5<t.length?5:t.length;for(let e=0;e<n;e++)t[e].offer&&r.appendChild(o(t[e]));e.appendChild(r)},deletePins:()=>{const t=e.querySelectorAll(".map__pin");for(let e=0;e<t.length;e++)t[e].classList.contains("map__pin--main")||t[e].remove()}}})(),(()=>{const e=document.querySelector(".map"),t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},o=document.querySelector(".map__filters-container"),r=document.querySelector("#card").content.querySelector(".map__card");window.card={renderCard:n=>{const s=r.cloneNode(!0),a=s.querySelector(".popup__photos"),c=s.querySelector(".popup__features"),d=s.querySelector(".popup__avatar"),i=s.querySelector(".popup__title"),l=s.querySelector(".popup__text--address"),u=s.querySelector(".popup__text--price"),p=s.querySelector(".popup__type"),m=s.querySelector(".popup__text--capacity"),f=s.querySelector(".popup__text--time"),_=s.querySelector(".popup__description");n.author.avatar?d.src=n.author.avatar:d.classList.add("hidden"),n.offer.title?i.textContent=n.offer.title:i.classList.add("hidden"),n.offer.address?l.textContent=n.offer.address:l.classList.add("hidden"),n.offer.price?u.textContent=n.offer.price+"₽/ночь":u.classList.add("hidden"),n.offer.type?p.textContent=t[n.offer.type]:p.classList.add("hidden"),n.offer.rooms&&n.offer.guests?m.textContent=`${n.offer.rooms} комнаты для ${n.offer.guests} гостей`:m.classList.add("hidden"),n.offer.checkin&&n.offer.checkout?f.textContent=`Заезд после ${n.offer.checkin}, выезд до ${n.offer.checkout}`:f.classList.add("hidden"),n.offer.description?_.textContent=n.offer.description:_.classList.add("hidden"),n.offer.photos?((e,t)=>{const o=e.querySelector(".popup__photo"),r=e.querySelector(".popup__photos");for(let e=0;e<t.offer.photos.length;e++){const n=o.cloneNode(!0);n.src=t.offer.photos[e],r.appendChild(n)}r.removeChild(o)})(s,n):a.classList.add("hidden"),n.offer.features?((e,t)=>{const o=e.querySelector(".popup__features");o.innerHTML="";for(let e=0;e<t.offer.features.length;e++){const r=document.createElement("li");r.classList.add("popup__feature","popup__feature--"+t.offer.features[e]),o.appendChild(r)}})(s,n):c.classList.add("hidden"),e.insertBefore(s,o)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=t.querySelector(".map__pin--main"),r=()=>{const o=e.querySelector(".map__card");o&&(o.remove(),t.querySelector(".map__pin--active").classList.remove("map__pin--active"),o.querySelector(".popup__close").removeEventListener("click",r),document.removeEventListener("keydown",n))},n=e=>{"Escape"===e.key&&(e.preventDefault(),r())},s=e=>{1===e.which&&window.page.activatePage()},a=e=>{"Enter"===e.key&&window.page.activatePage()};o.addEventListener("mousedown",s),o.addEventListener("keydown",a),window.map={closeCard:r,onPinPress:o=>{let s=o.target.closest(".map__pin");s&&!s.classList.contains("map__pin--main")&&(((o,s)=>{const a=t.querySelectorAll(".map__pin:not(:first-of-type)");r();for(let e=0;e<a.length;e++)a[e]===s&&window.card.renderCard(o[e]);e.querySelector(".map__card").querySelector(".popup__close").addEventListener("click",(()=>{r()})),document.addEventListener("keydown",n)})(window.filter.filteredOffers,s),s.classList.add("map__pin--active"))},onPinMainClick:s,onPinMainPress:a}})(),(()=>{const e={BUNGALOW:"0",FLAT:"1000",HOUSE:"5000",PALACE:"10000"},t=document.querySelector(".map__pins").querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),r=document.querySelectorAll(".map__filters select, .map__filters fieldset, .ad-form fieldset"),n=o.querySelector("#address"),s=o.querySelector("#room_number"),a=o.querySelector("#capacity"),c=o.querySelector("#type"),d=o.querySelector("#price"),i=o.querySelector("#timein"),l=o.querySelector("#timeout"),u=o.querySelector(".ad-form__reset"),p=document.querySelector("#success").content.querySelector(".success"),m=document.querySelector("#error").content.querySelector(".error"),f=(e,o)=>`${t.offsetLeft+e}, ${t.offsetTop+o}`,_=e=>{const t=e.options;return t[t.selectedIndex].textContent},w=()=>{"100"===s.value&&"0"!==a.value||"100"!==s.value&&"0"===a.value?s.setCustomValidity("100 комнат - не для гостей"):Number(s.value)<Number(a.value)?s.setCustomValidity(`${_(s)} — не ${_(a)}. Выберите больше комнат`):Number(s.value)>=Number(a.value)&&s.setCustomValidity("")};s.addEventListener("change",(()=>{w()})),a.addEventListener("change",(()=>{w()})),c.addEventListener("change",(()=>{((t,o)=>{const r=t.options,n=r[r.selectedIndex].value;o.setAttribute("placeholder",e[n.toUpperCase()]),o.setAttribute("min",e[n.toUpperCase()])})(c,d)}));const y=e=>{i.value=e.target.value,l.value=e.target.value};i.addEventListener("change",y),l.addEventListener("change",y);const v=e=>{const t=e.cloneNode(!0);document.querySelector("main").insertAdjacentElement("afterbegin",t),document.addEventListener("click",S),document.addEventListener("keydown",q)},S=()=>{(document.querySelector(".success")||document.querySelector(".error")).remove(),document.removeEventListener("click",S),document.removeEventListener("keydown",q)},q=e=>{const t=document.querySelector(".success")||document.querySelector(".error");"Escape"===e.key&&(e.preventDefault(),t.remove(),document.removeEventListener("click",S),document.removeEventListener("keydown",q))},h=()=>{window.page.resetPage(),v(p)},L=()=>{v(m);const e=document.querySelector(".error");e.tabindex=0,e.focus()};o.addEventListener("submit",(e=>{window.backend.load("POST","https://21.javascript.pages.academy/keksobooking",h,L,new FormData(o)),e.preventDefault()}));const g=e=>{e.preventDefault(),window.page.resetPage(),u.removeEventListener("click",g)};window.form={getAdressPin:f,enableForm:()=>{o.classList.remove("ad-form--disabled");for(let e=0;e<r.length;e++)r[e].disabled=!1;n.value=f(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT_ACTIVE),w(),u.addEventListener("click",g)},disableForm:()=>{o.classList.add("ad-form--disabled");for(let e=0;e<r.length;e++)r[e].disabled=!0;n.value=f(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT/2)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins").querySelector(".map__pin--main");t.addEventListener("mousedown",(o=>{o.preventDefault();const r=document.querySelector(".ad-form").querySelector("#address");let n={x:o.clientX,y:o.clientY};const s=o=>{o.preventDefault();let s=n.x-o.clientX,a=n.y-o.clientY;n={x:o.clientX,y:o.clientY};const c=0-window.constants.PIN_MAIN_WIDTH/2,d=e.clientWidth-window.constants.PIN_MAIN_WIDTH/2,i=130-window.constants.PIN_MAIN_HEIGHT_ACTIVE,l=630-window.constants.PIN_MAIN_HEIGHT_ACTIVE,u=t.offsetLeft-s,p=t.offsetTop-a;u>=c&&u<=d&&(t.style.left=u+"px"),p>=i&&p<=l&&(t.style.top=p+"px"),r.value=window.form.getAdressPin(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT_ACTIVE)},a=e=>{e.preventDefault(),r.value=window.form.getAdressPin(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT_ACTIVE),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",a)}))})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=t.querySelector(".map__pin--main"),r=document.querySelector(".ad-form"),n=e.querySelector(".map__filters"),s=r.querySelector(".ad-form-header__preview img").src,a=r.querySelector(".ad-form__photo").innerHTML,c=o.offsetLeft,d=o.offsetTop,i=e=>{window.pin.renderPins(e),window.page.offers=e,window.filter.filteredOffers=e,t.addEventListener("click",window.map.onPinPress)},l=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)};window.page={activatePage:()=>{e.classList.remove("map--faded"),window.form.enableForm(),o.removeEventListener("mousedown",window.map.onPinMainClick),o.removeEventListener("keydown",window.map.onPinMainPress),window.backend.load("GET","https://21.javascript.pages.academy/keksobooking/data",i,l)},resetPage:()=>{window.map.closeCard(),window.pin.deletePins(),e.classList.add("map--faded"),n.reset(),r.reset(),r.querySelector(".ad-form-header__preview img").src=s,r.querySelector(".ad-form__photo").innerHTML=a,o.style.left=c+"px",o.style.top=d+"px",window.form.disableForm(),o.addEventListener("mousedown",window.map.onPinMainClick),o.addEventListener("keydown",window.map.onPinMainPress),t.removeEventListener("click",window.map.onPinPress)},offers:[]}})(),window.form.disableForm()})();