(()=>{"use strict";window.constants={PIN_MAIN_WIDTH:62,PIN_MAIN_HEIGHT:62,PIN_MAIN_HEIGHT_ACTIVE:84},window.backend={load:(e,t,o,n,r="")=>{const s=new XMLHttpRequest;s.responseType="json",s.addEventListener("load",(()=>{switch(s.status){case 200:o(s.response);break;case 400:n("Неверный запрос");break;case 401:n("Ошибка авторизации");break;case 403:n("Доступ запрещен");break;case 404:n("Запрашиваемый ресурс не найден");break;case 500:n("Внутренняя ошибка сервера");break;default:n("Статус ответа: "+s.status+" "+s.statusText)}})),s.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{n("Запрос не успел выполниться за "+s.timeout+"мс")})),s.timeout=1e4,s.open(e,t),s.send(r)}},window.debounce=e=>{let t=null;return o=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(o)}),500)}},(()=>{const e=document.querySelector(".map__filters"),t=document.querySelector("#housing-type"),o=document.querySelector("#housing-price"),n=document.querySelector("#housing-rooms"),r=document.querySelector("#housing-guests"),s=document.querySelector("#housing-features");e.addEventListener("change",window.debounce((()=>{window.map.closeCard(),window.pin.deletePins(),window.filter.filteredOffers=window.page.offers.filter((e=>(e=>"any"===t.value||e.offer.type===t.value)(e)&&(e=>{switch(o.value){case"any":return!0;case"low":return e.offer.price<1e4;case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"high":return e.offer.price>5e4;default:return!1}})(e)&&(e=>"any"===n.value||e.offer.rooms.toString()===n.value)(e)&&(e=>"any"===r.value||e.offer.guests.toString()===r.value)(e)&&(e=>{const t=s.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))})(e))),window.pin.renderPins(window.filter.filteredOffers)}))),window.filter={filteredOffers:[]}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=e=>{const o=t.cloneNode(!0);return o.style.left=e.location.x-25+"px",o.style.top=e.location.y-70+"px",o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o};window.pin={renderPins:t=>{const n=document.createDocumentFragment();let r=5<t.length?5:t.length;for(let e=0;e<r;e++)t[e].offer&&n.appendChild(o(t[e]));e.appendChild(n)},deletePins:()=>{const t=e.querySelectorAll(".map__pin");for(let e=0;e<t.length;e++)t[e].classList.contains("map__pin--main")||t[e].remove()}}})(),(()=>{const e=document.querySelector(".map"),t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},o=document.querySelector(".map__filters-container"),n=document.querySelector("#card").content.querySelector(".map__card");window.card={renderCard:r=>{const s=n.cloneNode(!0),a=s.querySelector(".popup__photos"),c=s.querySelector(".popup__features"),i=s.querySelector(".popup__avatar"),d=s.querySelector(".popup__title"),l=s.querySelector(".popup__text--address"),u=s.querySelector(".popup__text--price"),p=s.querySelector(".popup__type"),m=s.querySelector(".popup__text--capacity"),f=s.querySelector(".popup__text--time"),_=s.querySelector(".popup__description");r.author.avatar?i.src=r.author.avatar:i.classList.add("hidden"),r.offer.title?d.textContent=r.offer.title:d.classList.add("hidden"),r.offer.address?l.textContent=r.offer.address:l.classList.add("hidden"),r.offer.price?u.textContent=r.offer.price+"₽/ночь":u.classList.add("hidden"),r.offer.type?p.textContent=t[r.offer.type]:p.classList.add("hidden"),r.offer.rooms&&r.offer.guests?m.textContent=`${r.offer.rooms} комнаты для ${r.offer.guests} гостей`:m.classList.add("hidden"),r.offer.checkin&&r.offer.checkout?f.textContent=`Заезд после ${r.offer.checkin}, выезд до ${r.offer.checkout}`:f.classList.add("hidden"),r.offer.description?_.textContent=r.offer.description:_.classList.add("hidden"),r.offer.photos?((e,t)=>{const o=e.querySelector(".popup__photo"),n=e.querySelector(".popup__photos");for(let e=0;e<t.offer.photos.length;e++){const r=o.cloneNode(!0);r.src=t.offer.photos[e],n.appendChild(r)}n.removeChild(o)})(s,r):a.classList.add("hidden"),r.offer.features?((e,t)=>{const o=e.querySelector(".popup__features");o.innerHTML="";for(let e=0;e<t.offer.features.length;e++){const n=document.createElement("li");n.classList.add("popup__feature","popup__feature--"+t.offer.features[e]),o.appendChild(n)}})(s,r):c.classList.add("hidden"),e.insertBefore(s,o)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=t.querySelector(".map__pin--main"),n=()=>{const o=e.querySelector(".map__card");o&&(o.remove(),t.querySelector(".map__pin--active").classList.remove("map__pin--active"),o.querySelector(".popup__close").removeEventListener("click",n),document.removeEventListener("keydown",r))},r=e=>{"Escape"===e.key&&(e.preventDefault(),n())},s=e=>{1===e.which&&window.page.activatePage()},a=e=>{"Enter"===e.key&&window.page.activatePage()};o.addEventListener("mousedown",s),o.addEventListener("keydown",a),window.map={closeCard:n,onPinPress:o=>{let s=o.target.closest(".map__pin");s&&!s.classList.contains("map__pin--main")&&(((o,s)=>{const a=t.querySelectorAll(".map__pin:not(:first-of-type)");n();for(let e=0;e<a.length;e++)a[e]===s&&window.card.renderCard(o[e]);e.querySelector(".map__card").querySelector(".popup__close").addEventListener("click",(()=>{n()})),document.addEventListener("keydown",r)})(window.filter.filteredOffers,s),s.classList.add("map__pin--active"))},onPinMainClick:s,onPinMainPress:a}})(),(()=>{const e={BUNGALOW:"0",FLAT:"1000",HOUSE:"5000",PALACE:"10000"},t=document.querySelector(".map__pins").querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),n=document.querySelectorAll(".map__filters select, .map__filters fieldset, .ad-form fieldset"),r=o.querySelector("#address"),s=o.querySelector("#room_number"),a=o.querySelector("#capacity"),c=o.querySelector("#type"),i=o.querySelector("#price"),d=o.querySelector("#timein"),l=o.querySelector("#timeout"),u=o.querySelector(".ad-form__reset"),p=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),m=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),f=(e,o)=>`${t.offsetLeft+e}, ${t.offsetTop+o}`,_=e=>{const t=e.options;return t[t.selectedIndex].textContent},w=()=>{"100"===s.value&&"0"!==a.value||"100"!==s.value&&"0"===a.value?s.setCustomValidity("100 комнат - не для гостей"):Number(s.value)<Number(a.value)?s.setCustomValidity(`${_(s)} — не ${_(a)}. Выберите больше комнат`):Number(s.value)>=Number(a.value)&&s.setCustomValidity("")};s.addEventListener("change",(()=>{w()})),a.addEventListener("change",(()=>{w()})),c.addEventListener("change",(()=>{((t,o)=>{const n=t.options,r=n[n.selectedIndex].value;o.setAttribute("placeholder",e[r.toUpperCase()]),o.setAttribute("min",e[r.toUpperCase()])})(c,i)}));const y=e=>{d.value=e.target.value,l.value=e.target.value};d.addEventListener("change",y),l.addEventListener("change",y);const v=()=>{p.remove(),document.removeEventListener("click",v),document.removeEventListener("keydown",q)},S=()=>{m.remove(),m.querySelector(".error__button").removeEventListener("click",S),document.removeEventListener("click",S),document.removeEventListener("keydown",q)},q=e=>{"Escape"===e.key&&(e.preventDefault(),p&&(p.remove(),document.removeEventListener("click",v)),m&&(m.remove(),document.removeEventListener("click",S),m.querySelector(".error__button").removeEventListener("click",S)),document.removeEventListener("keydown",q))},L=()=>{window.page.resetPage(),document.querySelector("main").insertAdjacentElement("afterbegin",p),document.addEventListener("click",v),document.addEventListener("keydown",q)},E=()=>{document.querySelector("main").insertAdjacentElement("afterbegin",m),m.querySelector(".error__button").addEventListener("click",S),document.addEventListener("click",S),document.addEventListener("keydown",q)};o.addEventListener("submit",(e=>{window.backend.load("POST","https://21.javascript.pages.academy/keksobooking",L,E,new FormData(o)),e.preventDefault()}));const h=e=>{e.preventDefault(),window.page.resetPage(),u.removeEventListener("click",h)};window.form={getAdressPin:f,enableForm:()=>{o.classList.remove("ad-form--disabled");for(let e=0;e<n.length;e++)n[e].disabled=!1;r.value=f(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT_ACTIVE),w(),u.addEventListener("click",h)},disableForm:()=>{o.classList.add("ad-form--disabled");for(let e=0;e<n.length;e++)n[e].disabled=!0;r.value=f(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT/2)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins").querySelector(".map__pin--main");t.addEventListener("mousedown",(o=>{o.preventDefault();const n=document.querySelector(".ad-form").querySelector("#address");let r={x:o.clientX,y:o.clientY};const s=o=>{o.preventDefault();let s=r.x-o.clientX,a=r.y-o.clientY;r={x:o.clientX,y:o.clientY};const c=0-window.constants.PIN_MAIN_WIDTH/2,i=e.clientWidth-window.constants.PIN_MAIN_WIDTH/2,d=130-window.constants.PIN_MAIN_HEIGHT_ACTIVE,l=630-window.constants.PIN_MAIN_HEIGHT_ACTIVE,u=t.offsetLeft-s,p=t.offsetTop-a;u>=c&&u<=i&&(t.style.left=u+"px"),p>=d&&p<=l&&(t.style.top=p+"px"),n.value=window.form.getAdressPin(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT_ACTIVE)},a=e=>{e.preventDefault(),n.value=window.form.getAdressPin(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT_ACTIVE),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",a)}))})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=t.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),r=e.querySelector(".map__filters"),s=o.offsetLeft,a=o.offsetTop,c=e=>{window.pin.renderPins(e),window.page.offers=e,window.filter.filteredOffers=e,t.addEventListener("click",window.map.onPinPress)},i=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)};window.page={activatePage:()=>{e.classList.remove("map--faded"),window.form.enableForm(),o.removeEventListener("mousedown",window.map.onPinMainClick),o.removeEventListener("keydown",window.map.onPinMainPress),window.backend.load("GET","https://21.javascript.pages.academy/keksobooking/data",c,i)},resetPage:()=>{window.map.closeCard(),window.pin.deletePins(),e.classList.add("map--faded"),r.reset(),n.reset(),o.style.left=s+"px",o.style.top=a+"px",window.form.disableForm(),o.addEventListener("mousedown",window.map.onPinMainClick),o.addEventListener("keydown",window.map.onPinMainPress),t.removeEventListener("click",window.map.onPinPress)},offers:[]}})(),window.form.disableForm()})();