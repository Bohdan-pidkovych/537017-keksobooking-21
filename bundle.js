(()=>{"use strict";window.constants={PIN_MAIN_WIDTH:62,PIN_MAIN_HEIGHT:62,PIN_MAIN_HEIGHT_ACTIVE:84},window.backend={load:(e,t,o,r,n="")=>{const s=new XMLHttpRequest;s.responseType="json",s.addEventListener("load",(()=>{switch(s.status){case 200:o(s.response);break;case 400:r("Неверный запрос");break;case 401:r("Ошибка авторизации");break;case 403:r("Доступ запрещен");break;case 404:r("Запрашиваемый ресурс не найден");break;case 500:r("Внутренняя ошибка сервера");break;default:r("Статус ответа: "+s.status+" "+s.statusText)}})),s.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за "+s.timeout+"мс")})),s.timeout=1e4,s.open(e,t),s.send(n)}},window.debounce=e=>{let t=null;return o=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(o)}),500)}},(()=>{const e=["jpg","jpeg","png","gif"],t=document.querySelector("#avatar"),o=document.querySelector("#images"),r=document.querySelector(".ad-form-header__preview"),n=document.querySelector(".ad-form__photo"),s=(t,o)=>{const n=t.files[0],s=n.name.toLowerCase();if(e.some((e=>s.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{if(o===r)o.querySelector("img").src=e.result;else{const t=document.createElement("img");t.src=e.result,t.alt="Фото жилья",t.width="70",t.height="70",o.appendChild(t)}})),e.readAsDataURL(n)}};t.addEventListener("change",(()=>{s(t,r)})),o.addEventListener("change",(()=>{s(o,n)}))})(),(()=>{const e="any",t=document.querySelector(".map__filters"),o=document.querySelector("#housing-type"),r=document.querySelector("#housing-price"),n=document.querySelector("#housing-rooms"),s=document.querySelector("#housing-guests"),a=document.querySelector("#housing-features");t.addEventListener("change",window.debounce((()=>{window.map.closeCard(),window.pin.deleteList(),window.filter.ads=window.page.offers.filter((t=>(t=>o.value===e||t.offer.type===o.value)(t)&&(t=>{switch(r.value){case e:return!0;case"low":return t.offer.price<1e4;case"middle":return t.offer.price>=1e4&&t.offer.price<=5e4;case"high":return t.offer.price>5e4;default:return!1}})(t)&&(t=>n.value===e||t.offer.rooms.toString()===n.value)(t)&&(t=>s.value===e||t.offer.guests.toString()===s.value)(t)&&(e=>{const t=a.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))})(t))),window.pin.renderList(window.filter.ads)}))),window.filter={ads:[]}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=e=>{const o=t.cloneNode(!0);return o.style.left=e.location.x-25+"px",o.style.top=e.location.y-70+"px",o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o};window.pin={renderList:t=>{const r=document.createDocumentFragment();let n=5<t.length?5:t.length;for(let e=0;e<n;e++)t[e].offer&&r.appendChild(o(t[e]));e.appendChild(r)},deleteList:()=>{e.querySelectorAll(".map__pin").forEach((e=>{e.classList.contains("map__pin--main")||e.remove()}))}}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector(".map"),o=document.querySelector(".map__filters-container"),r=document.querySelector("#card").content.querySelector(".map__card"),n=(e,t,o=t)=>{t?e.textContent=o:e.classList.add("hidden")};window.card={renderItem:s=>{const a=r.cloneNode(!0),c=a.querySelector(".popup__avatar"),i=a.querySelector(".popup__title"),d=a.querySelector(".popup__text--address"),l=a.querySelector(".popup__text--price"),u=a.querySelector(".popup__type"),p=a.querySelector(".popup__text--capacity"),m=a.querySelector(".popup__text--time"),f=a.querySelector(".popup__description");s.author.avatar?c.src=s.author.avatar:c.classList.add("hidden"),n(i,s.offer.title),n(d,s.offer.address),n(l,s.offer.price,s.offer.price+"₽/ночь"),n(u,s.offer.type,e[s.offer.type]),n(p,s.offer.rooms&&s.offer.guests,`${s.offer.rooms} комнаты для ${s.offer.guests} гостей`),n(m,s.offer.checkin&&s.offer.checkout,`Заезд после ${s.offer.checkin}, выезд до ${s.offer.checkout}`),n(f,s.offer.description),((e,t)=>{const o=e.querySelector(".popup__photo"),r=e.querySelector(".popup__photos");if(t.offer.photos){for(let e=0;e<t.offer.photos.length;e++){const n=o.cloneNode(!0);n.src=t.offer.photos[e],r.appendChild(n)}r.removeChild(o)}else r.classList.add("hidden")})(a,s),((e,t)=>{const o=e.querySelector(".popup__features");if(o.innerHTML="",t.offer.features)for(let e=0;e<t.offer.features.length;e++){const r=document.createElement("li");r.classList.add("popup__feature","popup__feature--"+t.offer.features[e]),o.appendChild(r)}else o.classList.add("hidden")})(a,s),t.insertBefore(a,o)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=t.querySelector(".map__pin--main"),r=()=>{const o=e.querySelector(".map__card");o&&(o.remove(),t.querySelector(".map__pin--active").classList.remove("map__pin--active"),o.querySelector(".popup__close").removeEventListener("click",r),document.removeEventListener("keydown",n))},n=e=>{"Escape"===e.key&&(e.preventDefault(),r())},s=e=>{1===e.which&&window.page.activate()},a=e=>{"Enter"===e.key&&window.page.activate()};o.addEventListener("mousedown",s),o.addEventListener("keydown",a),window.map={closeCard:r,onPinPress:o=>{let s=o.target.closest(".map__pin");s&&!s.classList.contains("map__pin--main")&&(((o,s)=>{const a=t.querySelectorAll(".map__pin:not(:first-of-type)");r(),a.forEach(((e,t)=>{e===s&&window.card.renderItem(o[t])})),e.querySelector(".map__card").querySelector(".popup__close").addEventListener("click",(()=>{r()})),document.addEventListener("keydown",n)})(window.filter.ads,s),s.classList.add("map__pin--active"))},onPinMainClick:s,onPinMainPress:a}})(),(()=>{const e={BUNGALOW:"0",FLAT:"1000",HOUSE:"5000",PALACE:"10000"},t=document.querySelector(".map__pins").querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),r=document.querySelectorAll(".map__filters select, .map__filters fieldset, .ad-form fieldset"),n=o.querySelector("#address"),s=o.querySelector("#room_number"),a=o.querySelector("#capacity"),c=o.querySelector("#type"),i=o.querySelector("#price"),d=o.querySelector("#timein"),l=o.querySelector("#timeout"),u=o.querySelector(".ad-form__reset"),p=document.querySelector("#success").content.querySelector(".success"),m=document.querySelector("#error").content.querySelector(".error"),f=(e,o)=>`${t.offsetLeft+e}, ${t.offsetTop+o}`,_=e=>{const t=e.options;return t[t.selectedIndex].textContent},w=()=>{"100"===s.value&&"0"!==a.value||"100"!==s.value&&"0"===a.value?s.setCustomValidity("100 комнат - не для гостей"):Number(s.value)<Number(a.value)?s.setCustomValidity(`${_(s)} — не ${_(a)}. Выберите больше комнат`):Number(s.value)>=Number(a.value)&&s.setCustomValidity("")};s.addEventListener("change",(()=>{w()})),a.addEventListener("change",(()=>{w()})),c.addEventListener("change",(()=>{((t,o)=>{const r=t.options,n=r[r.selectedIndex].value;o.placeholder=e[n.toUpperCase()],o.min=e[n.toUpperCase()]})(c,i)}));const y=e=>{d.value=e.target.value,l.value=e.target.value};d.addEventListener("change",y),l.addEventListener("change",y);const v=e=>{const t=e.cloneNode(!0);document.querySelector("main").insertAdjacentElement("afterbegin",t),document.addEventListener("click",S),document.addEventListener("keydown",q)},S=()=>{(document.querySelector(".success")||document.querySelector(".error")).remove(),document.removeEventListener("click",S),document.removeEventListener("keydown",q)},q=e=>{"Escape"===e.key&&(e.preventDefault(),S())},h=()=>{window.page.reset(),v(p)},L=()=>{v(m);const e=document.querySelector(".error");e.tabindex=0,e.focus()};o.addEventListener("submit",(e=>{e.preventDefault(),window.backend.load("POST","https://21.javascript.pages.academy/keksobooking",h,L,new FormData(o))}));const g=e=>{e.preventDefault(),window.page.reset(),u.removeEventListener("click",g)};window.form={getAdressPin:f,enable:()=>{o.classList.remove("ad-form--disabled");for(let e=0;e<r.length;e++)r[e].disabled=!1;n.value=f(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT_ACTIVE),w(),u.addEventListener("click",g)},disable:()=>{o.classList.add("ad-form--disabled");for(let e=0;e<r.length;e++)r[e].disabled=!0;n.value=f(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT/2)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins").querySelector(".map__pin--main");t.addEventListener("mousedown",(o=>{o.preventDefault();const r=document.querySelector(".ad-form").querySelector("#address");let n={x:o.clientX,y:o.clientY};const s=o=>{o.preventDefault();let s=n.x-o.clientX,a=n.y-o.clientY;n={x:o.clientX,y:o.clientY};const c=0-window.constants.PIN_MAIN_WIDTH/2,i=e.clientWidth-window.constants.PIN_MAIN_WIDTH/2,d=130-window.constants.PIN_MAIN_HEIGHT_ACTIVE,l=630-window.constants.PIN_MAIN_HEIGHT_ACTIVE,u=t.offsetLeft-s,p=t.offsetTop-a;u>=c&&u<=i&&(t.style.left=u+"px"),p>=d&&p<=l&&(t.style.top=p+"px"),r.value=window.form.getAdressPin(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT_ACTIVE)},a=e=>{e.preventDefault(),r.value=window.form.getAdressPin(window.constants.PIN_MAIN_WIDTH/2,window.constants.PIN_MAIN_HEIGHT_ACTIVE),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",a)}))})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=t.querySelector(".map__pin--main"),r=document.querySelector(".ad-form"),n=e.querySelector(".map__filters"),s=r.querySelector(".ad-form-header__preview img").src,a=o.offsetLeft,c=o.offsetTop,i=e=>{window.pin.renderList(e),window.page.offers=e,window.filter.ads=e,t.addEventListener("click",window.map.onPinPress)},d=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)};window.page={activate:()=>{e.classList.remove("map--faded"),window.form.enable(),o.removeEventListener("mousedown",window.map.onPinMainClick),o.removeEventListener("keydown",window.map.onPinMainPress),window.backend.load("GET","https://21.javascript.pages.academy/keksobooking/data",i,d)},reset:()=>{window.map.closeCard(),window.pin.deleteList(),e.classList.add("map--faded"),n.reset(),r.reset(),r.querySelector(".ad-form-header__preview img").src=s,r.querySelector(".ad-form__photo").innerHTML="",o.style.left=a+"px",o.style.top=c+"px",window.form.disable(),o.addEventListener("mousedown",window.map.onPinMainClick),o.addEventListener("keydown",window.map.onPinMainPress),t.removeEventListener("click",window.map.onPinPress)},offers:[]}})(),window.form.disable()})();